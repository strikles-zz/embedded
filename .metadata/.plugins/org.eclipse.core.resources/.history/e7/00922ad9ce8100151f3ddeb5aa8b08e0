/*
 ============================================================================
 Name        : client.c
 Author      : 
 Version     :
 Copyright   : Your copyright notice
 Description : Hello World in C, Ansi-style
 ============================================================================
 */

#include <time.h>
#include <unistd.h>

#include <netdb.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/types.h>

#include "net.h"
#include "xml.h"

#include "sensors.h"
#include "client.h"

#ifdef TEST
#include "test.h"
#endif


int main(int argc,char **argv)
{
	srand(time(NULL));

	// generic declarations
    char sendline[MAX_MSG_LEN];
    char recvline[MAX_MSG_LEN];
    int error_status = 0;

    // linux - addr declarations
    int socket_desc = socket(AF_INET, SOCK_STREAM, 0);
    struct sockaddr_in server_addr;
    bzero(&server_addr, sizeof server_addr);
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(SRV_PORT);
    inet_pton(AF_INET, SRV_ADDR, &(server_addr.sin_addr));

    while(1)
    {
        if((error_status = connect(socket_desc, (struct sockaddr *)&server_addr, sizeof(server_addr))) == -1)
        {
        	perror("ERROR failed to connect to server\n");
        }

        // generate Measurements
        if((error_status = generateMeasurements()))
        {
        	continue;
        }

        // build request
        if((error_status = buildRequestXML(update, sendline)))
        {
        	continue;
        }

        // send
        if((error_status = writeSocket(socket_desc, sendline)) == -1)
        {
        	continue;
        }

    	// read
        if((error_status = readSocket(socket_desc, recvline)) == -1)
        {
        	continue;
        }

        close(socket_desc);

        // linux specific
        sleep(5);
    }
}
